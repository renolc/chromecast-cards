// Generated by CoffeeScript 1.8.0
var animate, bus, create_card, init, manager, on_message, renderer, sides, stage, suits, throw_card, values;

stage = null;

renderer = null;

manager = null;

bus = null;

suits = ['spades', 'clubs', 'hearts', 'diamonds'];

values = ['ace', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'jack', 'queen', 'king'];

sides = ['bottom', 'top', 'left', 'right'];

init = function() {
  stage = new PIXI.Stage(0x66FF99);
  renderer = PIXI.autoDetectRenderer(window.innerWidth - 15, window.innerHeight - 15, null, false, true);
  manager = cast.receiver.CastReceiverManager.getInstance();
  bus = manager.getCastMessageBus('urn:x-cast:com.renolc.cards', cast.receiver.CastMessageBus.MessageType.JSON);
  bus.onMessage = on_message;
  document.body.appendChild(renderer.view);
  requestAnimFrame(animate);
  manager.start();

  /*
  !!!!!!!!!!!!!!!!!! DEEBUG ONLY !!!!!!!!!!!!!!!!!!!!!!!!!!!
   */
  return stage.click = function() {
    return throw_card();
  };
};


/*
PIXI methods
 */

throw_card = function(value, suit, side) {
  var card, random_offset_x, random_offset_y, x, y;
  if (value == null) {
    value = values.random();
  }
  if (suit == null) {
    suit = suits.random();
  }
  if (side == null) {
    side = sides.random();
  }
  card = create_card(value, suit);
  random_offset_x = Math.randomBetween(-50, 50);
  random_offset_y = Math.randomBetween(-50, 50);
  switch (side) {
    case 'bottom':
      y = window.innerHeight + 200;
      x = window.innerWidth / 2;
      break;
    case 'top':
      y = -200;
      x = window.innerWidth / 2;
      break;
    case 'left':
      y = window.innerHeight / 2;
      x = -200;
      break;
    case 'right':
      y = window.innerHeight / 2;
      x = window.innerWidth + 200;
  }
  card.position = new PIXI.Point(x, y);
  stage.addChild(card);
  return setTimeout(function() {
    return new TWEEN.Tween(card).to({
      x: window.innerWidth / 2 + random_offset_x,
      y: window.innerHeight / 2 + random_offset_y,
      rotation: Math.randomBetween(-5, 5)
    }, 850).easing(TWEEN.Easing.Circular.Out).start();
  }, 200);
};

create_card = function(value, suit) {
  var card;
  card = new PIXI.Sprite.fromImage("img/cards/" + value + "_of_" + suit + ".png");
  card.anchor.x = 0.5;
  card.anchor.y = 0.5;
  card.scale = new PIXI.Point(0.3, 0.3);
  return card;
};

animate = function(time) {
  requestAnimFrame(animate);
  TWEEN.update(time);
  return renderer.render(stage);
};


/*
Chromecast methods
 */

on_message = function(event) {
  return throw_card(event.data.value, event.data.suit, event.data.side);
};


/*
Util methods
 */

Array.prototype.random = function() {
  if (this.length === 0) {
    return;
  }
  return this[Math.floor(Math.random() * this.length)];
};

Math.randomBetween = function(min, max) {
  return Math.random() * (max - min) + min;
};

init();
